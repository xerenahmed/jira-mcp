name: Build and Release mcp-server

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      matrix:
        platform:
          - name: Linux x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: mcp-server-linux-x86_64
          - name: macOS x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
            artifact_name: mcp-server-macos-x86_64
          - name: macOS ARM64
            os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: mcp-server-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build mcp-server
        run: cargo build --release --package mcp-server --target ${{ matrix.platform.target }}

      - name: Strip binary (Unix)
        if: runner.os != 'Windows'
        run: |
          strip "target/${{ matrix.platform.target }}/release/mcp-server" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.artifact_name }}
          path: target/${{ matrix.platform.target }}/release/mcp-server
          if-no-files-found: error

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Rename binaries for release
        run: |
          cd artifacts
          for dir in */; do
            platform="${dir%/}"
            mv "${dir}mcp-server" "${dir}${platform}"
          done

      - name: Generate release info
        id: release_info
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          # Use heredoc syntax for multiline commit message, filter out Co-Authored-By
          {
            echo 'commit_msg<<EOF'
            git log -1 --pretty=%B | grep -v "Co-Authored-By"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v0.1.0-${{ steps.release_info.outputs.short_sha }}
          name: Release v0.1.0-${{ steps.release_info.outputs.short_sha }}
          body: |
            Build for commit: ${{ github.sha }}

            **Commit Message:**
            ${{ steps.release_info.outputs.commit_msg }}

            **Binaries:**
            - Linux x86_64
            - macOS x86_64 (Intel)
            - macOS ARM64 (Apple Silicon)
          files: artifacts/**/*
          draft: false
          prerelease: false
